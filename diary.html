<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê³µê° ë‹¤ì´ì–´ë¦¬ ğŸŒ±</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="app-container">
        <header>
            <h1>AI ê³µê° ë‹¤ì´ì–´ë¦¬ ğŸŒ±</h1>
            <p class="subtitle">ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”. ë”°ëœ»í•œ ìœ„ë¡œë¥¼ ì „í•´ë“œë¦´ê²Œìš”.</p>
        </header>

        <!-- API Key Status Bar -->
        <div class="api-bar">
            <div class="api-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">API í‚¤ í™•ì¸ í•„ìš”</span>
            </div>
            <button class="btn-small" onclick="openKeyModal()">ì„¤ì •</button>
        </div>

        <!-- Write Diary Section -->
        <div class="write-section">
            <textarea id="diaryInput" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ìš”? ì§§ê²Œë¼ë„ ì¢‹ìœ¼ë‹ˆ ë§ˆìŒ ì† ì´ì•¼ê¸°ë¥¼ ì ì–´ë³´ì„¸ìš”..."></textarea>
            <button class="btn-primary" id="submitBtn" onclick="handleDiarySubmit()">
                <span class="btn-text">ê³µê° ë°›ê¸° âœ¨</span>
                <span class="spinner" style="display: none;"></span>
            </button>
        </div>

        <!-- Diary List -->
        <div id="diaryList" class="diary-list">
            <!-- Diaries will be inserted here -->
            <div class="empty-state">ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì‹¤ë˜ìš”? ğŸ“</div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="keyModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ”‘ API í‚¤ ì„¤ì •</h2>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                OpenRouter API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
            <input type="password" id="apiKeyInput" class="input-field" placeholder="sk-or-v1-...">
            <button class="btn-primary" onclick="saveKeyFromModal()">ì €ì¥í•˜ê¸°</button>
            <button class="btn-small" onclick="closeKeyModal()"
                style="margin-top: 10px; width: 100%; border: none;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="app.js?v=5"></script>
    <script>
        // UI Interaction Logic
        const diaryInput = document.getElementById('diaryInput');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const spinner = submitBtn.querySelector('.spinner');
        const diaryList = document.getElementById('diaryList');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const keyModal = document.getElementById('keyModal');

        // Initialization
        window.addEventListener('DOMContentLoaded', () => {
            updateApiStatus();
            renderDiaries();
        });

        // API Status Update
        function updateApiStatus() {
            const hasKey = !!localStorage.getItem('openrouter_api_key');
            if (hasKey) {
                statusDot.classList.add('active');
                statusText.textContent = "AI ì—°ê²° ì¤€ë¹„ ì™„ë£Œ";
                state.apiKey = localStorage.getItem('openrouter_api_key');
            } else {
                statusDot.classList.remove('active');
                statusText.textContent = "API í‚¤ ì„¤ì • í•„ìš”";
            }
        }

        // Modal Functions
        function openKeyModal() {
            keyModal.style.display = 'flex';
            document.getElementById('apiKeyInput').value = localStorage.getItem('openrouter_api_key') || '';
        }

        function closeKeyModal() {
            keyModal.style.display = 'none';
        }

        function saveKeyFromModal() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            saveApiKey(key);
            closeKeyModal();
            updateApiStatus();
            alert('í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”');
        }

        // Submit Logic
        async function handleDiarySubmit() {
            const text = diaryInput.value.trim();
            if (!text) {
                alert('ì¼ê¸° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                diaryInput.focus();
                return;
            }

            if (!state.apiKey) {
                openKeyModal();
                return;
            }

            // UI Loading State
            setLoading(true);

            try {
                // 1. Call AI
                const aiResult = await analyzeDiaryWithAI(text);

                // 2. Save Data
                const diaryData = {
                    content: text,
                    ...aiResult
                };
                saveDiary(diaryData);

                // 3. Update UI
                diaryInput.value = '';
                renderDiaries();

            } catch (error) {
                alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ğŸ˜¢\n${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            if (isLoading) {
                btnText.textContent = 'ë§ˆìŒì„ ì½ëŠ” ì¤‘...';
                spinner.style.display = 'inline-block';
            } else {
                btnText.textContent = 'ê³µê° ë°›ê¸° âœ¨';
                spinner.style.display = 'none';
            }
        }

        // Render Logic
        function renderDiaries() {
            const diaries = getDiaries();

            if (diaries.length === 0) {
                diaryList.innerHTML = '<div class="empty-state">ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì‹¤ë˜ìš”? ğŸ“</div>';
                return;
            }

            diaryList.innerHTML = diaries.map(diary => `
                <div class="diary-card" style="border-left-color: ${diary.color || '#ddd'}">
                    <div class="diary-header">
                        <span>${diary.date} ${new Date(diary.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="emotion-tag" style="background-color: ${diary.color || '#999'}">${diary.emotion}</span>
                            <button class="delete-btn" onclick="removeDiary(${diary.id})">&times;</button>
                        </div>
                    </div>
                    <div class="diary-content">${escapeHtml(diary.content)}</div>
                    <div class="ai-response">
                        <h4>ğŸ¤– AI ì‹¬ë¦¬ ìƒë‹´ê°€ì˜ ë‹µì¥</h4>
                        <p class="empathy-text">"${escapeHtml(diary.empathy_message)}"</p>
                        <div class="advice-text">ğŸ’¡ ${escapeHtml(diary.advice)}</div>
                    </div>
                </div>
            `).join('');
        }

        function removeDiary(id) {
            if (confirm('ì´ ì¼ê¸°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) {
                deleteDiary(id);
                renderDiaries();
            }
        }

        // Security Utility (Prevention of XSS)
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>

</html>